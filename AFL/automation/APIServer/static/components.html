<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Component Database Editor</title>
<link rel="stylesheet" href="ag-grid/ag-grid.css">
<link rel="stylesheet" href="ag-grid/ag-theme-alpine.css">
<script src="ag-grid/ag-grid-community.min.noStyle.js"></script>
<style>
  html, body, #myGrid {height:100%; width:100%; margin:0; padding:0;}
</style>
</head>
<body>
<button id="add-row">Add Row</button>
<button id="delete-row">Delete Selected</button>
<div id="myGrid" class="ag-theme-alpine"></div>
<script>
async function fetchComponents() {
    console.log('Fetching components...');
    const resp = await fetch('/list_components');
    console.log('Fetch status:', resp.status);
    if (!resp.ok) { return []; }
    const data = await resp.json();
    console.log('Received components:', data);
    return data;
}
function sendUpdate(data) {
    console.log('Updating component', data);
    fetch('/update_component', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
}
function sendAdd(data) {
    console.log('Adding component', data);
    fetch('/add_component', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)})
        .then(res => res.text())
        .then(uid => {
            console.log('Server returned uid', uid);
            data.uid = uid;
            gridOptions.api.refreshCells();
        });
}
function sendDelete(rows) {
    console.log('Deleting rows', rows);
    rows.forEach(r => fetch('/remove_component', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({uid:r.uid})}));
}
var gridOptions = {
    columnDefs: [
        {field:'uid', editable:false},
        {field:'name', editable:true},
        {field:'density', editable:true},
        {field:'formula', editable:true}
    ],
    rowData: [],
    rowSelection: 'single',
    onCellValueChanged: params => sendUpdate(params.data),
    onGridReady: () => {
        console.log('Grid ready, loading data');
        fetchComponents().then(data => {
            gridOptions.api.setRowData(data);
        });
    }
};
var eGridDiv = document.querySelector('#myGrid');
if (agGrid.createGrid) {
    console.log('Initializing grid using createGrid');
    agGrid.createGrid(eGridDiv, gridOptions);
} else {
    console.log('Initializing grid using new agGrid.Grid');
    new agGrid.Grid(eGridDiv, gridOptions);
}

document.getElementById('add-row').addEventListener('click', ()=>{
    if (!gridOptions.api) return;
    const newRow = {name:'', density:'', formula:''};
    gridOptions.api.applyTransaction({add:[newRow]});
    sendAdd(newRow);
});

document.getElementById('delete-row').addEventListener('click', ()=>{
    if (!gridOptions.api) return;
    const selected = gridOptions.api.getSelectedRows();
    if (selected.length){
        gridOptions.api.applyTransaction({remove:selected});
        sendDelete(selected);
    }
});
</script>
</body>
</html>
