<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Component Database Editor</title>

  <!-- ag-Grid Community (v33+) assets -->
  <link rel="stylesheet" href="ag-grid-community/styles/ag-grid.css" />
  <link rel="stylesheet" href="ag-grid-community/styles/ag-theme-alpine.css" />
  <script src="ag-grid-community/dist/ag-grid-community.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #myGrid    { height: calc(100% - 38px); width: 100%; }
  </style>
</head>
<body>
  <button id="add-row">Add Row</button>
  <button id="delete-row">Delete Selected</button>

  <div id="myGrid" class="ag-theme-alpine"></div>

  <script type="module">
    let jwtToken = null;

    /* ---------- helpers that hit your Flask endpoints ---------- */
    async function login() {
      if (jwtToken) return jwtToken;
      const response = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: 'your_username', password: 'domo_arigato' })
      });
      if (!response.ok) {
        throw new Error('Failed to login');
      }
      const data = await response.json();
      jwtToken = data.token;
      return jwtToken;
    }

    const fetchComponents = async () => {
      const r = await fetch('/query_driver?r=list_components');
      return r.ok ? r.json() : [];
    };

    async function enqueueTask(task) {
      const token = await login();
      const r = await fetch('/enqueue', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(task)
      });
      if (!r.ok) {
        console.error('Failed to enqueue', task);
      }
    }

    const sendUpdate = (rec) =>
      enqueueTask({ task_name: 'update_component', ...rec });

    function sendAdd(rec) {
      enqueueTask({ task_name: 'add_component', ...rec }).then(() => refreshGrid());
    }

    const sendDelete = (rows) => {
      rows.forEach((r) =>
        enqueueTask({ task_name: 'remove_component', uid: r.uid })
      );
      refreshGrid();
    }

    async function refreshGrid() {
      if (!gridApi) return;
      const rows = await fetchComponents();
      gridApi.setRowData(rows);
    }

    /* ---------- ag-Grid setup ---------- */
    let gridApi;   // filled once the grid is ready

    const gridOptions = {
      columnDefs: [
        { field: 'uid',     headerName: 'UID',     editable: false },
        { field: 'name',    headerName: 'Name',    editable: true },
        { field: 'density', headerName: 'Density', editable: true },
        { field: 'formula', headerName: 'Formula', editable: true },
      ],
      defaultColDef: { flex: 1, resizable: true },
      rowData: [],               // start empty
      rowSelection: 'single',

      /* all data changes handled with applyTransaction ------------------- */
      onCellValueChanged: (e) => sendUpdate(e.data),

      onGridReady: async (params) => {
        gridApi = params.api;
        const rows = await fetchComponents();
        if (rows.length) {
          gridApi.applyTransaction({ add: rows });  // initial load
        }
      },
    };

    /* create the grid */
    agGrid.createGrid(document.querySelector('#myGrid'), gridOptions);

    /* ---------- toolbar ---------- */
    document.getElementById('add-row').addEventListener('click', () => {
      if (!gridApi) return;
      const blank = { name: '', density: '', formula: '' };
      gridApi.applyTransaction({ add: [blank], addIndex: 0 });
      sendAdd(blank);
    });

    document.getElementById('delete-row').addEventListener('click', () => {
      if (!gridApi) return;
      const sel = gridApi.getSelectedRows();
      if (!sel.length) return;
      gridApi.applyTransaction({ remove: sel });
      sendDelete(sel);
    });
  </script>
</body>
</html>
