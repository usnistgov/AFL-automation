<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Component Database Editor</title>

  <!-- ag-Grid Community (v33+) assets -->
  <link rel="stylesheet" href="ag-grid-community/styles/ag-grid.css" />
  <link rel="stylesheet" href="ag-grid-community/styles/ag-theme-alpine.css" />
  <script src="ag-grid-community/dist/ag-grid-community.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #myGrid    { height: calc(100% - 38px); width: 100%; }
  </style>
</head>
<body>
  <button id="add-row">Add Row</button>
  <button id="delete-row">Delete Selected</button>

  <div id="myGrid" class="ag-theme-alpine"></div>

  <script type="module">
    /* ---------- helpers that hit your Flask endpoints ---------- */
    const fetchComponents = async () => {
      const r = await fetch('/list_components');
      return r.ok ? r.json() : [];
    };

    const sendUpdate = (rec) =>
      fetch('/update_component', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(rec),
      });

    function sendAdd(rec) {
      fetch('/add_component', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(rec),
      })
        .then((r) => r.text())
        .then((uid) => {
          rec.uid = uid;
          gridApi.applyTransaction({ update: [rec] });   // update row in-place
        });
    }

    const sendDelete = (rows) =>
      rows.forEach((r) =>
        fetch('/remove_component', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ uid: r.uid }),
        })
      );

    /* ---------- ag-Grid setup ---------- */
    let gridApi;   // filled once the grid is ready

    const gridOptions = {
      columnDefs: [
        { field: 'uid',     headerName: 'UID',     editable: false },
        { field: 'name',    headerName: 'Name',    editable: true },
        { field: 'density', headerName: 'Density', editable: true },
        { field: 'formula', headerName: 'Formula', editable: true },
      ],
      defaultColDef: { flex: 1, resizable: true },
      rowData: [],               // start empty
      rowSelection: 'single',

      /* all data changes handled with applyTransaction ------------------- */
      onCellValueChanged: (e) => sendUpdate(e.data),

      onGridReady: async (params) => {
        gridApi = params.api;
        const rows = await fetchComponents();
        if (rows.length) {
          gridApi.applyTransaction({ add: rows });  // initial load
        }
      },
    };

    /* create the grid */
    agGrid.createGrid(document.querySelector('#myGrid'), gridOptions);

    /* ---------- toolbar ---------- */
    document.getElementById('add-row').addEventListener('click', () => {
      if (!gridApi) return;
      const blank = { name: '', density: '', formula: '' };
      gridApi.applyTransaction({ add: [blank], addIndex: 0 });
      sendAdd(blank);
    });

    document.getElementById('delete-row').addEventListener('click', () => {
      if (!gridApi) return;
      const sel = gridApi.getSelectedRows();
      if (!sel.length) return;
      gridApi.applyTransaction({ remove: sel });
      sendDelete(sel);
    });
  </script>
</body>
</html>
